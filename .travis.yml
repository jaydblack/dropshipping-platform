language: php

dist: trusty

php:
    - 7.2

env:
    global:
        - APP_ENV=test_cached

jobs:
    include:
        -   
            stage: test
            name: "Symfony 4.3.* build"

            env: SYMFONY_VERSION="4.3.*" SYLIUS_CACHE_DIR=$HOME/.sylius-cache SYLIUS_BUILD_DIR=etc/build

        -
            stage: test
            name: "Docker build"

            sudo: required

            env: DOCKER_COMPOSE_VERSION=1.22.0

            services:
                - docker

            addons:
                apt:
                    packages:
                        - docker-ce

            before_install:
                # Install custom version of docker-composer
                - sudo rm /usr/local/bin/docker-compose
                - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
                - chmod +x docker-compose
                - sudo mv docker-compose /usr/local/bin

                # Shutdown vanilla mysql
                - sudo service mysql stop
                - while sudo lsof -Pi :3306 -sTCP:LISTEN -t; do sleep 1; done

            script:
                - docker-compose --version
                - docker-compose pull --ignore-pull-failures || true
                - docker-compose build --pull
                - docker-compose up -d

                - sleep 60

                - docker-compose exec php bin/console sylius:fixtures:load --no-interaction

                - curl http://localhost/

            before_deploy:
                - echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin "$DOCKER_REGISTRY"

            deploy:
                provider: script
                script: docker-compose push
                skip_cleanup: true
                on:
                    repo: Sylius/Sylius-Standard
                    tags: true
